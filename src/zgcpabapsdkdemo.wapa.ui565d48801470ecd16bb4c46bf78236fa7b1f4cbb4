sap.ui.define([                                                                                                                                                                                                                                                
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/ui/core/BusyIndicator",                                                                                                                                                                                                                               
    "sap/m/MessageBox"                                                                                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                             
],                                                                                                                                                                                                                                                             
    /**                                                                                                                                                                                                                                                        
     * @param {typeof sap.ui.core.mvc.Controller} Controller                                                                                                                                                                                                   
     */                                                                                                                                                                                                                                                        
    function (Controller, JSONModel, BusyIndicator, MessageBox) {                                                                                                                                                                                              
        "use strict";                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        return Controller.extend("com.google.googlecloudabapsdkdemo.controller.PurchaseOrder", {                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            onInit: function () {                                                                                                                                                                                                                              
                var that = this                                                                                                                                                                                                                                
                var _data = {                                                                                                                                                                                                                                  
                    PurchaseOrderSet: {},                                                                                                                                                                                                                      
                    Document: {},                                                                                                                                                                                                                              
                    DocumentData: {}                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                this.getOwnerComponent().getModel().read("/PurchaseOrderSet", {                                                                                                                                                                                
                    success: function (oData) {                                                                                                                                                                                                                
                        var purchaseOrderSet = new JSONModel(oData);                                                                                                                                                                                           
                        _data.PurchaseOrderSet = purchaseOrderSet.getData()                                                                                                                                                                                    
                        var _mainModel = new JSONModel(_data)                                                                                                                                                                                                  
                        that.getView().setModel(_mainModel, "mainModel");                                                                                                                                                                                      
                        that.getView().getModel("mainModel").refresh();                                                                                                                                                                                        
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            toDocument: function (documentName) {                                                                                                                                                                                                              
                var that = this                                                                                                                                                                                                                                
                that.showBusyIndicator(10000)                                                                                                                                                                                                                  
                var _mainModel = that.getView().getModel("mainModel")                                                                                                                                                                                          
                var _data = _mainModel.getData()                                                                                                                                                                                                               
                var _uri = "/PurchaseOrderSet('" + encodeURIComponent(documentName) + "')/Document"                                                                                                                                                            
                                                                                                                                                                                                                                                               
                this.getOwnerComponent().getModel().read(_uri, {                                                                                                                                                                                               
                    success: function (oData) {                                                                                                                                                                                                                
                        var _poDocument = new JSONModel(oData).getData();                                                                                                                                                                                      
                        var b64String = _poDocument.DocumentContent;                                                                                                                                                                                           
                        const bytes = atob(b64String)                                                                                                                                                                                                          
                        let length = bytes.length;                                                                                                                                                                                                             
                        let out = new Uint8Array(length);                                                                                                                                                                                                      
                        while (length--) {                                                                                                                                                                                                                     
                            out[length] = bytes.charCodeAt(length);                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                        const blob = new Blob([out.buffer], { type: _poDocument.MimeType })                                                                                                                                                                    
                        _data.Document = _poDocument;                                                                                                                                                                                                          
                        _data.Document.blobUrl = URL.createObjectURL(blob)                                                                                                                                                                                     
                        jQuery.sap.addUrlWhitelist("blob")                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        _mainModel = new JSONModel(_data)                                                                                                                                                                                                      
                        that.getView().setModel(_mainModel, "mainModel");                                                                                                                                                                                      
                        that.getView().getModel("mainModel").refresh();                                                                                                                                                                                        
                        that.getView().byId("scan_button").setEnabled(true)                                                                                                                                                                                    
                        that.hideBusyIndicator()                                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            toDocumentData: function (documentName) {                                                                                                                                                                                                          
                var that = this                                                                                                                                                                                                                                
                that.showBusyIndicator(10000)                                                                                                                                                                                                                  
                var _mainModel = that.getView().getModel("mainModel")                                                                                                                                                                                          
                var _data = _mainModel.getData()                                                                                                                                                                                                               
                var _uri = "/DocumentSet('" + encodeURIComponent(documentName) + "')/DocumentData"                                                                                                                                                             
                                                                                                                                                                                                                                                               
                this.getOwnerComponent().getModel().read(_uri, {                                                                                                                                                                                               
                    urlParameters: {                                                                                                                                                                                                                           
                        "$expand": "DocumentDataItemSet"                                                                                                                                                                                                       
                    },                                                                                                                                                                                                                                         
                    success: function (oData) {                                                                                                                                                                                                                
                        _data.DocumentData = new JSONModel(oData).getData();                                                                                                                                                                                   
                        _mainModel = new JSONModel(_data)                                                                                                                                                                                                      
                        that.getView().byId("order_entry_view").setVisible(true)                                                                                                                                                                               
                        that.getView().byId("create_button").setEnabled(true)                                                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        that.getView().setModel(_mainModel, "mainModel");                                                                                                                                                                                      
                        that.getView().getModel("mainModel").refresh();                                                                                                                                                                                        
                        that.hideBusyIndicator()                                                                                                                                                                                                               
                    },                                                                                                                                                                                                                                         
                    error: function(err){                                                                                                                                                                                                                      
                        console.log("error in scanning document", err)                                                                                                                                                                                         
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            createSalesOrder: function(){                                                                                                                                                                                                                      
                //Create the entity                                                                                                                                                                                                                            
                var that = this                                                                                                                                                                                                                                
                that.showBusyIndicator(10000)                                                                                                                                                                                                                  
                var _mainModel = that.getView().getModel("mainModel")                                                                                                                                                                                          
                var _data = _mainModel.getData()                                                                                                                                                                                                               
                var _oModel = this.getOwnerComponent().getModel()                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                _oModel.create("/DocumentDataSet", _data.DocumentData,{                                                                                                                                                                                        
                    success: function(oData){                                                                                                                                                                                                                  
                        that.hideBusyIndicator()                                                                                                                                                                                                               
                        var _documentData = new JSONModel(oData).getData();                                                                                                                                                                                    
                        console.log("Order is ", _documentData)                                                                                                                                                                                                
                        MessageBox.information("Sales Order created succssfully with no.: " + _documentData.SalesOrderNumber);                                                                                                                                 
                        that.refresh_screen()                                                                                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                    },                                                                                                                                                                                                                                         
                    error: function(err){                                                                                                                                                                                                                      
                        console.log('Error is ', err)                                                                                                                                                                                                          
                        that.hideBusyIndicator()                                                                                                                                                                                                               
                        MessageBox.error("Error in creating Sales Order")                                                                                                                                                                                      
                        that.refresh_screen()                                                                                                                                                                                                                  
                    }                                                                                                                                                                                                                                          
                })                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            refresh_screen: function(){                                                                                                                                                                                                                        
                var _view = this.getView()                                                                                                                                                                                                                     
                _view.byId("create_button").setEnabled(false)                                                                                                                                                                                                  
                _view.byId('order_entry_view').setVisible(false)                                                                                                                                                                                               
                _view.byId("scan_button").setEnabled(false)                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                var _mainModel = _view.getModel("mainModel")                                                                                                                                                                                                   
                var _data = _mainModel.getData()                                                                                                                                                                                                               
                _data.DocumentData = {}                                                                                                                                                                                                                        
                _data.Document = {}                                                                                                                                                                                                                            
                this.getView().setModel(_mainModel, "mainModel");                                                                                                                                                                                              
                this.getView().getModel("mainModel").refresh();                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            hideBusyIndicator: function () {                                                                                                                                                                                                                   
                BusyIndicator.hide();                                                                                                                                                                                                                          
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showBusyIndicator : function (iDuration, iDelay) {                                                                                                                                                                                                 
                BusyIndicator.show(iDelay);                                                                                                                                                                                                                    
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                if (iDuration && iDuration > 0) {                                                                                                                                                                                                              
                    if (this._sTimeoutId) {                                                                                                                                                                                                                    
                        clearTimeout(this._sTimeoutId);                                                                                                                                                                                                        
                        this._sTimeoutId = null;                                                                                                                                                                                                               
                    }                                                                                                                                                                                                                                          
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                    this._sTimeoutId = setTimeout(function() {                                                                                                                                                                                                 
                        this.hideBusyIndicator();                                                                                                                                                                                                              
                    }.bind(this), iDuration);                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        });                                                                                                                                                                                                                                                    
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               